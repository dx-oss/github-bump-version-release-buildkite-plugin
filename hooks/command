#!/bin/bash

# https://buildkite.com/docs/pipelines/writing-build-scripts
set -euo pipefail

# common

docker=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_DOCKER:-docker}
debug=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_DEBUG:-0}
if [ $debug -gt 0 ]; then
    set -euox pipefail

    env
    $docker version
    $docker ps
    whoami
    pwd    
fi

dotnet=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_DOTNET:-dotnet}
github_release=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_RELEASE:-github-release}
buildkite_agent=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_AGENT:-buildkite-agent}
image="dxdx/docker-builder-dotnet:2.2"
image=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_IMAGE:-$image}

pull=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_PULL:-1}
if [ $pull -gt 0 ]; then
    $docker pull $image
fi

# version

version="v0.0.0"
dotnet_args="--rm -it $image /gitversion/GitVersion.dll /output json /nofetch /showvariable semVer"
version=$($docker run -v $(pwd):/src -w /src --entrypoint dotnet $dotnet_args | sed 's/[^a-zA-Z0-9\.\-\_]//g')

if [ "$version" = "" ]; then
    $buildkite_agent annotate --style error "Cannot get any version"

    exit 1    
else
    $buildkite_agent meta-data set version $version
    $buildkite_agent annotate --style info "Using [$image] with GitVersion and SemVer"
    $buildkite_agent annotate --style success "Bump to version ${version}"

    export VERSION=$version

    echo $version
fi

# release

if [ "$GITHUB_TOKEN" = "" ]; then
    echo "GITHUB_TOKEN token is not set"

    $buildkite_agent annotate --style error "Cannot release version ${version} with GITHUB_TOKEN is not set"

    exit 1
fi

dry=${BUILDKITE_PLUGIN_GITHUB_BUMP_VERSION_RELEASE_DRY:-0}
if [ $dry -gt 0 ]; then
    $buildkite_agent annotate --style success "Push release ${version} (dry-run)"
else
    export GITHUB_USER=$(echo "git@github.com:dxcn/oxy-dotnet-foundation.git" | cut -d: -f 2 | cut -d/ -f 1)
    export GITHUB_REPO=$(echo "$BUILDKITE_REPO" | cut -d: -f 2 | cut -d/ -f 2 | cut -d. -f 1)

    $docker run -e "GITHUB_USER=$GITHUB_USER" -e "GITHUB_REPO=$GITHUB_REPO" -e "GITHUB_TOKEN=$GITHUB_TOKEN" -v $(pwd):/src -w /src --entrypoint $github_release --rm -it $image release -t "${version}"
    $buildkite_agent annotate --style success "Push release ${version}"
fi
